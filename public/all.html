<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" type="text/css" title="Cool stylesheet" href="style.css">
</head>
<body>
  <h1>Online Confession Room</h1>
  <form action='/'>
    <input id="repost"  type="submit" value="Post a new confession" />
  </form>


  <script >
    let lat, long, timestamp, getdistance, gettime;

    if('geolocation' in navigator) {
      navigator.geolocation.watchPosition((position) =>{
        lat = position.coords.latitude;
        long = position.coords.longitude;
        timestamp = Date.now()
        getData();
      //  console.log(lat,long)
      });
    } else {
      console.log("geolocation not availabel")
    }


    async function getData(){
      const response = await fetch('/api');
      const data = await response.json();

      for(item of data){
        getdistance = getDistanceFromLatLonInKm(lat, long,`${item.lat}`,`${item.long}`).toFixed(2);
        gettime = timeDifference(timestamp, `${item.timestamp}`)
        //console.log(`${item.timestamp}`,gettime)

        if ( getdistance<=1 && gettime<=24){
          const root = document.createElement('div')
          const name = document.createElement('div')
          name.textContent = `name: ${item.name}`
          const distance = document.createElement('div')
          distance.textContent = "distance:" + getdistance +"Km"
          const date = document.createElement('div')
          const dateString = new Date(item.timestamp).toLocaleString()
          date.textContent = dateString
          const confession = document.createElement('div')
          confession.textContent = `confession:${item.confess}`

          root.append(name, distance, date, confession)
          root.setAttribute("id", "post")
          document.body.append(root);
        }
      }

    };






    //calculate distance

       function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
        var R = 6371; // Radius of the earth in km
        var dLat = deg2rad(lat2-lat1);  // deg2rad below
        var dLon = deg2rad(lon2-lon1);
        var a =
          Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
          Math.sin(dLon/2) * Math.sin(dLon/2)
          ;
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        var d = R * c; // Distance in km
        return d;
      }

      function deg2rad(deg) {
        return deg * (Math.PI/180)
      }
    //calculate timeout

    function timeDifference(timestamp1, timestamp2) {
      var difference = timestamp1 - timestamp2;
      var hoursDifference = Math.floor(difference/1000/60/60);

    return hoursDifference;
}

  </script>
</body>
</html>
